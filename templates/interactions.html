{% extends "base.html" %}
{% block content %}
<h1 id='header-name' data='{{ user_id }}' class="title">
    {{ session['profile']['given_name'] }}'s Interactions
</h1>
<h2 class="subtitle">
  Keep up with your people
</h2>
<div class="container">
    <button id="add-interaction-btn" class='button'>&plus;</button>
</div>
<div id='add-interaction-container' class="container has-text-left hidden">
    <div class="box">
        <div class="field">
            <label class="label">Contact</label>
            <div class="field is-horizontal">
                <input class="input" id="contact-input" type="text" placeholder="Name">
                <input type="button" id='contact-match-button' class="button is-primary hidden">
                <input class="input hidden" id="contact-frequency" type="number" placeholder="Contact Frequency (days)">
                <button id='add-button' class="button is-warning hidden">Add</button>
            </div>
        </div>
        <div class="field">
            <label class="label">Method</label>
            <input class="input" id="method-input" type="text" placeholder="Text, Call, etc">
        </div>
        <!-- <div class="field">
            <label class="label">Date</label>
            <input class="input" id="date-input" type="date" placeholder="Leave blank if today">
        </div>   -->
        <div class="field">
            <label class="label">Duration</label>
            <input class="input" id="duration-input" type="number" placeholder="How many mintues?">
        </div>
        <div class="field">
            <label class="label">Notes</label>
            <textarea id="notes-input" class="textarea" plceholder="I should remember..."></textarea>
        </div>
        <div class="field">
            <input id='submit-interaction-btn' class="button is-primary" type="submit" value="Add Interaction">
        </div>
    </div>
</div>    

{% endblock %}

{% block javascript %}
<script>
    updateContactNames = function() {
        fetch(
            '/users/' + userId + '/contacts', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
        .then(response => response.json())
        .then(jsonResponse => {
            contactsNames = jsonResponse['contactsNames']
            console.log(jsonResponse);
            console.log("contactsNames: " + contactsNames)
        })
    }
    setAddContactVisibility = function(visible) {
        if (visible) {
            addContactButton.classList.remove('hidden')
            contactFrequencyInput.classList.remove('hidden')
            contactMatchButton.classList.add('hidden')
        }
        else {
            addContactButton.classList.add('hidden')
            contactFrequencyInput.classList.add('hidden')
        }
    }

    const userId = document.getElementById('header-name').getAttribute('data')
    var contactsNames = []
    var possibleName = "";

    var contactInputValue = "";
    const contactInputElement = document.getElementById('contact-input')
    const addContactButton = document.getElementById('add-button')
    const contactMatchButton = document.getElementById('contact-match-button')
    const contactFrequencyInput = document.getElementById('contact-frequency')
    const submitInteractionButton = document.getElementById('submit-interaction-btn')
    const addInteractionButton = document.getElementById('add-interaction-btn')
    const addInteractionContainer = document.getElementById('add-interaction-container')

    updateContactNames()

    addInteractionButton.onclick = function(e) {
        addInteractionContainer.classList.remove('hidden')
        addInteractionButton.classList.add('hidden')
    }
    contactInputElement.oninput = function(e) {
        contactInputValue = e.target.value;
        // console.log(contactInputValue)
        // get first match in contacts with contactInputValue beginning
        try {
            possibleName = contactsNames.filter(
            name => name.toLowerCase().substring(0,contactInputValue.length) == contactInputValue.toLowerCase()
            )[0]

            console.log("possibleName: " + possibleName)
        }
        
        catch(err) {
            console.log("Error finding possibleName: " + err)
        }
        
        if (contactInputValue.length == 0) {
            setAddContactVisibility(false)
            contactMatchButton.classList.add('hidden')
        }
        else if (typeof possibleName === "undefined" && contactInputValue.length != 0) {
            setAddContactVisibility(true)
        }
        else {
            setAddContactVisibility(false)
            contactMatchButton.classList.remove('hidden')
            contactMatchButton.value = possibleName
        }
    }

    addContactButton.onclick = function(e) {
        e.preventDefault();
        if (confirm("Add " + contactInputValue + "?")) {
            fetch(
                '/contacts/' + userId, {
                    method: 'POST',
                    body: JSON.stringify({
                        'contactName': contactInputValue,
                        'contactFrequency': contactFrequencyInput.value
                    }),
                    headers: {
                        "Content-Type": "application/json"
                    }
                }
            )
            .then(response => response.json())
            .then(jsonResponse => console.log(jsonResponse))
            .then( () => {
                updateContactNames()
                setAddContactVisibility(false)
            })
        }
    }
    contactMatchButton.onclick = function(e) {
        contactInputElement.value = possibleName;
        contactInputValue = possibleName
    }
    submitInteractionButton.onclick = function(e) {
        e.preventDefault()
        // TODO setup this fetch request
        fetch(
            '/interactions/' + userId, {
                method: 'POST',
                body: JSON.stringify({
                    'contactName': contactInputValue,
                    'contactMethod' : document.getElementById('method-input').value,
                    'duration': document.getElementById('duration-input').value,
                    'notes': document.getElementById('notes-input').value
                }),
                headers: {
                    'Content-Type': 'application/json'
                }
            }
        )
        .then(response => response.json())
        .then(jsonResponse => console.log(jsonResponse))
        .then( () => {
            addInteractionContainer.classList.add('hidden')
            addInteractionButton.classList.remove('hidden')
        })
    }



</script>
{% endblock %}